# MIT License
# Copyright (c) 2020 Jason Hu, Zhu Yu

# 支持Bochs和vbox
FATFS_DIR	= tools/fatfs

# 系统环境变量
ifeq ($(OS),Windows_NT)
	FATFS_BIN		:= fatfs
else
	FATFS_BIN		:= $(FATFS_DIR)/fatfs
endif

# 镜像和只读存储器
IMAGE_DIR	= develop/image
HDA_VHD		= $(IMAGE_DIR)/c.vhd
HDB_VHD		= $(IMAGE_DIR)/d.vhd

HDA_VMDK	= $(IMAGE_DIR)/c-flat.vmdk
HDB_VMDK	= $(IMAGE_DIR)/d-flat.vmdk

ROM_DIR		= develop/rom

# 虚拟机
BOCHS 		= bochs
BOCHSDBG 	= bochsdbg
VBOX_MANAGE = VBoxManage

# 脚本文件夹
SCRIPTS_DIR	= scripts

# Bochs开发环境文件夹
BOCHS_DIR       = $(SCRIPTS_DIR)/bochs/
BXRC_WIN 		= $(BOCHS_DIR)bochsrc.win   # bochsrc 对于 windows
BXRC_LINUX 		= $(BOCHS_DIR)bochsrc.linux # bochsrc 对于 linux
VBOX_NAME	    = "BookOS"                   # virtual box 虚拟机名称

# 参数
.PHONY: all bochs bochsdbg vbox vmware

# bochs
bochs:
ifeq ($(OS),Windows_NT)
	$(BOCHS) -q -f $(BXRC_WIN)
else
	$(BOCHS) -q -f $(BXRC_LINUX)
endif

# bochsdbg
bochsdbg:
ifeq ($(OS),Windows_NT)
	$(BOCHSDBG) -q -f $(BXRC_WIN)
else
	$(BOCHSDBG) -q -f $(BXRC_LINUX)
endif

# virtual box
vbox: vbox_disk
	$(VBOX_MANAGE) startvm $(VBOX_NAME) --type gui 

vbox_disk:
	$(FATFS_BIN) $(HDB_VHD) $(ROM_DIR) 0

vmware:
	$(FATFS_BIN) $(HDB_VMDK) $(ROM_DIR) 0
